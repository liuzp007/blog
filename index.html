<!DOCTYPE html>
<html>

<head>
  <title>è¶£å‘³è‡ªæ‹ç›¸æœº Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* å…¨å±€æ ·å¼ä¼˜åŒ– */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-color: #6366f1;
      --secondary-color: #8b5cf6;
      --text-color: #1f2937;
      --bg-color: #f5f7fa;
      --border-radius: 16px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg-color) 0%, #c3cfe2 100%);
      min-height: 100vh;
      color: var(--text-color);
    }

    .container {
      text-align: center;
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
      position: relative;
    }

    /* ç›¸æœºé¢„è§ˆåŒºåŸŸä¼˜åŒ– */
    .camera-container {
      position: relative;
      margin: 20px auto;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
      background: #fff;
      padding: 25px;
      transition: var(--transition);
    }

    #video,
    #canvas {
      width: 100%;
      max-width: 1000px;
      margin: 0 auto;
      border-radius: calc(var(--border-radius) - 4px);
      transition: var(--transition);
      object-fit: cover;
    }

    #canvas {
      border: 4px solid #fff;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
    }

    /* æŒ‰é’®æ ·å¼ä¼˜åŒ– */
    .btn {
      padding: 16px 32px;
      font-size: 17px;
      font-weight: 600;
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      color: white;
      border: none;
      border-radius: 40px;
      cursor: pointer;
      margin: 15px;
      transition: var(--transition);
      box-shadow: 0 6px 15px rgba(99, 102, 241, 0.25);
      position: relative;
      overflow: hidden;
    }

    .btn::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, rgba(255, 255, 255, 0.2), transparent);
      transition: var(--transition);
    }

    .btn:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(99, 102, 241, 0.35);
    }

    .btn:hover::after {
      transform: translateX(100%);
    }

    .btn:active {
      transform: translateY(1px);
    }

    /* ç…§ç‰‡å¢™å®¹å™¨ä¼˜åŒ– */
    .photo-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      perspective: 2000px;
      z-index: 10;
    }

    /* ç…§ç‰‡é¡¹æ ·å¼ä¼˜åŒ– */
    .photo-item {
      position: absolute;
      width: 320px;
      border-radius: calc(var(--border-radius) - 4px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.18);
      transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
      opacity: 0;
      animation: fadeIn 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      cursor: pointer;
      transform-style: preserve-3d;
      backface-visibility: hidden;
      border: 5px solid #fff;
      pointer-events: auto;
    }

    .photo-item:hover {
      transform: scale(1.1) translateZ(40px) rotateY(5deg);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
      z-index: 100 !important;
    }

    /* æ»¤é•œé€‰é¡¹ä¼˜åŒ– */
    .filter-options {
      margin: 30px 0;
      display: flex;
      justify-content: center;
      gap: 18px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 14px 28px;
      border: 2.5px solid #e5e7eb;
      border-radius: 35px;
      background: white;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 600;
      font-size: 15px;
      color: #4b5563;
      position: relative;
      overflow: hidden;
    }

    .filter-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      opacity: 0;
      transition: var(--transition);
      z-index: -1;
    }

    .filter-btn:hover {
      background: transparent;
      color: white;
      transform: translateY(-3px);
    }

    .filter-btn:hover::before {
      opacity: 1;
    }

    .filter-btn.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    /* å€’è®¡æ—¶åŠ¨ç”»ä¼˜åŒ– */
    .countdown {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 250px;
      font-weight: bold;
      color: white;
      text-shadow: 0 0 40px rgba(0, 0, 0, 0.35);
      z-index: 1000;
      display: none;
      animation: pulseAndRotate 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) infinite;
    }

    @keyframes pulseAndRotate {
      0% {
        transform: translate(-50%, -50%) scale(1) rotate(0deg);
        opacity: 0.8;
      }

      50% {
        transform: translate(-50%, -50%) scale(1.3) rotate(8deg);
        opacity: 1;
      }

      100% {
        transform: translate(-50%, -50%) scale(1) rotate(0deg);
        opacity: 0.8;
      }
    }

    /* åŠ è½½åŠ¨ç”»ä¼˜åŒ– */
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      font-size: 26px;
    }

    /* æç¤ºæ¡†æ ·å¼ä¼˜åŒ– */
    .tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 15px;
      pointer-events: none;
      transition: var(--transition);
      z-index: 1000;
      backdrop-filter: blur(6px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
    }

    /* å“åº”å¼ä¼˜åŒ– */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      .btn {
        padding: 12px 20px;
        font-size: 14px;
        margin: 8px;
      }

      .photo-item {
        width: 200px;
      }

      .countdown {
        font-size: 120px;
      }

      .filter-options {
        margin: 15px 0;
        gap: 10px;
      }

      .filter-btn {
        padding: 10px 16px;
        font-size: 13px;
      }

      .camera-container {
        padding: 15px;
      }

      #video,
      #canvas {
        max-width: 100%;
      }

      .tooltip {
        padding: 8px 12px;
        font-size: 13px;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 8px;
      }

      .btn {
        padding: 10px 16px;
        font-size: 13px;
        margin: 6px;
      }

      .filter-btn {
        padding: 8px 14px;
        font-size: 12px;
      }

      .photo-item {
        width: 160px;
      }

      .countdown {
        font-size: 100px;
      }

      .camera-container {
        padding: 10px;
        margin: 10px auto;
      }

      .loading {
        font-size: 20px;
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.8) translateY(20px);
      }

      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div style="position: relative;">
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas"></canvas>
      <div class="countdown" id="countdown"></div>
    </div>
    <div class="filter-options">
      <button class="filter-btn active" data-filter="normal" title="åŸå§‹æ•ˆæœ">æ­£å¸¸</button>
      <button class="filter-btn" data-filter="grayscale" title="é»‘ç™½æ»¤é•œ">é»‘ç™½</button>
      <button class="filter-btn" data-filter="sepia" title="å¤å¤æ•ˆæœ">å¤å¤</button>
      <button class="filter-btn" data-filter="invert" title="åè‰²æ•ˆæœ">åè‰²</button>
      <button class="filter-btn" data-filter="blur" title="æ¨¡ç³Šæ•ˆæœ">æ¨¡ç³Š</button>
      <button class="filter-btn" data-filter="brightness" title="æ˜äº®æ•ˆæœ">æ˜äº®</button>
      <button class="filter-btn" data-filter="contrast" title="å¯¹æ¯”åº¦æ•ˆæœ">å¯¹æ¯”åº¦</button>
      <button class="filter-btn" data-filter="saturate" title="é¥±å’Œåº¦æ•ˆæœ">é¥±å’Œåº¦</button>
    </div>
    <button id="takePhotoBtn" class="btn">ğŸ“¸ æ‹ç…§</button>
    <button id="generateBtn" class="btn" style="display: none;">âœ¨ ç”Ÿæˆè¶£å‘³ç…§ç‰‡å¢™</button>
    <button id="retakeBtn" class="btn" style="display: none;">ğŸ“¸ é‡æ–°æ‹ç…§</button>
    <button id="saveBtn" class="btn" style="display: none;">ğŸ’¾ ä¿å­˜ç…§ç‰‡</button>
  </div>
  <div class="photo-container" id="photoContainer"></div>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const video = document.getElementById('video')
      const canvas = document.getElementById('canvas')
      const takePhotoBtn = document.getElementById('takePhotoBtn')
      const generateBtn = document.getElementById('generateBtn')
      const retakeBtn = document.getElementById('retakeBtn')
      const saveBtn = document.getElementById('saveBtn')
      const photoContainer = document.getElementById('photoContainer')
      const countdown = document.getElementById('countdown')
      let currentFilter = 'normal'
      let isGenerating = false

      // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // æ‰©å±•æ»¤é•œæ•ˆæœ
      const filters = {
        normal: '',
        grayscale: 'grayscale(100%)',
        sepia: 'sepia(100%)',
        invert: 'invert(100%)',
        blur: 'blur(3px)',
        brightness: 'brightness(130%)',
        contrast: 'contrast(150%)',
        saturate: 'saturate(180%)'
      }

      // æ‰©å±•éšæœºæ–‡å­—æ•°ç»„
      const funnyTexts = [
        { cn: 'ä½ çœ‹å•¥å‘¢', en: 'What are you looking at' },
        { cn: 'æˆ‘è¶…å¸…çš„', en: "I'm so handsome" },
        { cn: 'æ¥å¼ è‡ªæ‹', en: 'Selfie time' },
        { cn: 'ç¬‘ä¸€ä¸ªå‘—', en: 'Smile please' },
        { cn: 'è¿™æ˜¯ä»€ä¹ˆè¡¨æƒ…', en: 'What kind of face is this' },
        { cn: 'ä»Šå¤©çœŸå¼€å¿ƒ', en: "Today is awesome" },
        { cn: 'æ‰“ä¸ªæ‹›å‘¼', en: 'Say hello' },
        { cn: 'è®°å½•ç¾å¥½æ—¶åˆ»', en: 'Capture the moment' },
        { cn: 'è¿™ä¸€åˆ»çœŸç¾', en: 'Beautiful moment' },
        { cn: 'æ°¸è¿œå¹´è½»', en: 'Forever young' }
      ]

      // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
      function showLoading(message) {
        const loading = document.createElement('div')
        loading.className = 'loading'
        loading.innerHTML = `
          <div style="text-align: center">
            <div style="margin-bottom: 15px">${message}</div>
            <div class="loading-spinner"></div>
          </div>
        `
        document.body.appendChild(loading)
        return loading
      }

      // å¯åŠ¨æ‘„åƒå¤´
      async function startCamera() {
        const loading = showLoading('æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...')
        try {
          const constraints = {
            video: {
              width: { ideal: isMobile ? 1280 : 1920 },
              height: { ideal: isMobile ? 720 : 1080 },
              facingMode: isMobile ? "environment" : "user"
            }
          }
          const stream = await navigator.mediaDevices.getUserMedia(constraints)
          video.srcObject = stream

          video.addEventListener('loadeddata', () => {
            loading.remove()
            canvas.style.display = 'none'
            video.style.display = 'block'
            takePhotoBtn.style.display = 'inline-block'
            generateBtn.style.display = 'none'
            retakeBtn.style.display = 'none'
            saveBtn.style.display = 'none'
          })

        } catch (err) {
          loading.remove()
          console.error('æ— æ³•è®¿é—®æ‘„åƒå¤´:', err)
          if (confirm('è¯·å…è®¸è®¿é—®æ‘„åƒå¤´ä»¥ç»§ç»­ä½¿ç”¨ï¼ç‚¹å‡»ç¡®å®šé‡è¯•ã€‚')) {
            startCamera()
          }
        }
      }

      // å¢å¼ºçš„å€’è®¡æ—¶æ•ˆæœ
      function startCountdown() {
        let count = isMobile ? 2 : 3 // ç§»åŠ¨ç«¯ç¼©çŸ­å€’è®¡æ—¶
        countdown.style.display = 'block'
        countdown.style.opacity = '0'

        const timer = setInterval(() => {
          countdown.style.opacity = '1'
          countdown.textContent = count
          if (count === 0) {
            clearInterval(timer)
            countdown.style.display = 'none'
            takePhoto()
          }
          count--
        }, 1000)
      }

      // ä¼˜åŒ–çš„éšæœºä½ç½®ç”Ÿæˆ
      function getRandomPosition() {
        const margin = isMobile ? 30 : 60
        const photoWidth = isMobile ? 160 : 280
        return {
          x: margin + Math.random() * (window.innerWidth - photoWidth - margin * 2),
          y: margin + Math.random() * (window.innerHeight - photoWidth - margin * 2),
          rotate: (Math.random() - 0.5) * (isMobile ? 25 : 35),
          scale: isMobile ? (0.7 + Math.random() * 0.3) : (0.85 + Math.random() * 0.4)
        }
      }

      // å¢å¼ºçš„ç…§ç‰‡å¢™ç”Ÿæˆæ•ˆæœ
      async function generatePhotos() {
        if (isGenerating) return;
        isGenerating = true;

        try {
          if (!canvas.toDataURL) {
            throw new Error('Canvas not ready');
          }

          const imageUrl = canvas.toDataURL('image/png');
          if (imageUrl === 'data:,') {
            throw new Error('Canvas is empty');
          }

          photoContainer.innerHTML = '';

          // ä½¿ç”¨requestAnimationFrameå’ŒPromiseæ¥åˆ†æ‰¹åˆ›å»ºç…§ç‰‡
          const totalPhotos = isMobile ? 50 : 65;
          const batchSize = isMobile ? 3 : 5;
          const batches = Math.ceil(totalPhotos / batchSize);

          for (let batch = 0; batch < batches; batch++) {
            await new Promise(resolve => {
              requestAnimationFrame(() => {
                for (let i = 0; i < batchSize; i++) {
                  const index = batch * batchSize + i;
                  if (index >= totalPhotos) break;

                  const img = document.createElement('img');
                  img.src = imageUrl;
                  img.className = 'photo-item';
                  const { x, y, rotate, scale } = getRandomPosition();
                  img.style.left = `${x}px`;
                  img.style.top = `${y}px`;
                  img.style.transform = `rotate(${rotate}deg) scale(${scale})`;
                  img.style.zIndex = Math.floor(Math.random() * 40);
                  img.style.animationDelay = `${index * (isMobile ? 0.08 : 0.12)}s`;

                  // æ·»åŠ è§¦æ‘¸/ç‚¹å‡»äº‹ä»¶
                  if (isMobile) {
                    img.addEventListener('click', () => {
                      const modal = document.createElement('div');
                      Object.assign(modal.style, {
                        position: 'fixed',
                        top: '0',
                        left: '0',
                        width: '100%',
                        height: '100%',
                        background: 'rgba(0,0,0,0.95)',
                        display: 'flex',
                        justifyContent: 'center',
                        alignItems: 'center',
                        zIndex: '9999'
                      });

                      const modalImg = document.createElement('img');
                      Object.assign(modalImg.style, {
                        maxWidth: '95%',
                        maxHeight: '95%',
                        borderRadius: '8px',
                        border: '3px solid white'
                      });
                      modalImg.src = imageUrl;

                      modal.appendChild(modalImg);
                      document.body.appendChild(modal);

                      modal.addEventListener('click', () => {
                        modal.remove();
                      });
                    });
                  } else {
                    // æ¡Œé¢ç«¯ä¿æŒåŸæœ‰çš„æ‚¬åœæ•ˆæœ
                    img.addEventListener('mouseover', (e) => {
                      const tooltip = document.createElement('div');
                      tooltip.className = 'tooltip';
                      tooltip.textContent = 'ç‚¹å‡»æŸ¥çœ‹å¤§å›¾';
                      tooltip.style.left = `${e.pageX + 15}px`;
                      tooltip.style.top = `${e.pageY + 15}px`;
                      document.body.appendChild(tooltip);

                      const moveHandler = (e) => {
                        tooltip.style.left = `${e.pageX + 15}px`;
                        tooltip.style.top = `${e.pageY + 15}px`;
                      };

                      img.addEventListener('mousemove', moveHandler);

                      img.addEventListener('mouseout', () => {
                        tooltip.remove();
                        img.removeEventListener('mousemove', moveHandler);
                      }, { once: true });
                    });

                    img.addEventListener('click', () => {
                      const modal = document.createElement('div');
                      Object.assign(modal.style, {
                        position: 'fixed',
                        top: '0',
                        left: '0',
                        width: '100%',
                        height: '100%',
                        background: 'rgba(0,0,0,0.95)',
                        display: 'flex',
                        justifyContent: 'center',
                        alignItems: 'center',
                        zIndex: '9999',
                        backdropFilter: 'blur(10px)'
                      });

                      const modalImg = document.createElement('img');
                      Object.assign(modalImg.style, {
                        maxWidth: '95%',
                        maxHeight: '95%',
                        borderRadius: '12px',
                        border: '5px solid white',
                        boxShadow: '0 15px 40px rgba(0,0,0,0.3)',
                        transition: 'var(--transition)'
                      });
                      modalImg.src = imageUrl;

                      modal.appendChild(modalImg);
                      document.body.appendChild(modal);

                      modal.addEventListener('click', () => {
                        modal.remove();
                      });
                    });
                  }

                  photoContainer.appendChild(img);
                }
                resolve();
              });
            });
          }
        } catch (error) {
          console.error('ç”Ÿæˆç…§ç‰‡å¢™æ—¶å‡ºé”™:', error);
        } finally {
          isGenerating = false;
        }
      }

      // ä¼˜åŒ–çš„æ‹ç…§åŠŸèƒ½
      function takePhoto() {
        canvas.width = video.videoWidth
        canvas.height = video.videoHeight

        const context = canvas.getContext('2d')
        context.filter = filters[currentFilter]
        context.drawImage(video, 0, 0, canvas.width, canvas.height)

        const randomText = funnyTexts[Math.floor(Math.random() * funnyTexts.length)]

        // ä¼˜åŒ–æ–‡å­—æ¸²æŸ“
        context.filter = 'none'
        context.font = `bold ${isMobile ? '36px' : '52px'} Arial`
        context.textAlign = 'center'

        // æ·»åŠ æ–‡å­—é˜´å½±æ•ˆæœ
        context.shadowColor = 'rgba(0,0,0,0.6)'
        context.shadowBlur = isMobile ? 8 : 12
        context.shadowOffsetX = isMobile ? 2 : 3
        context.shadowOffsetY = isMobile ? 2 : 3

        // ä¸­æ–‡å­—å¹•
        context.strokeStyle = 'white'
        context.lineWidth = isMobile ? 4 : 5
        context.strokeText(randomText.cn, canvas.width / 2, canvas.height - (isMobile ? 50 : 70))
        context.fillStyle = 'black'
        context.fillText(randomText.cn, canvas.width / 2, canvas.height - (isMobile ? 50 : 70))

        // è‹±æ–‡å­—å¹•
        context.font = `bold ${isMobile ? '26px' : '38px'} Arial`
        context.strokeText(randomText.en, canvas.width / 2, canvas.height - (isMobile ? 15 : 25))
        context.fillText(randomText.en, canvas.width / 2, canvas.height - (isMobile ? 15 : 25))


        canvas.toBlob((blob) => {
          const file = new File([blob], 'canvas-image.png', {
            type: 'image/png',
            lastModified: Date.now()
          });

          const formData = new FormData();
          formData.append('image', file); // ç¡®ä¿å­—æ®µåç§°ä¸º 'image'

          fetch('http://10.220.140.192:10086/upload', {
            method: 'POST',
            body: formData
          })
            .then(response => response.json())
            .then(data => {
              console.log(data); // å¤„ç†æˆåŠŸå“åº”
            })
            .catch(error => {
              console.error('ä¸Šä¼ å¤±è´¥:', error); // å¤„ç†é”™è¯¯
            });
        }, 'image/png', 0.9);


        // å…³é—­æ‘„åƒå¤´
        const stream = video.srcObject
        const tracks = stream.getTracks()
        tracks.forEach(track => track.stop())
        video.srcObject = null
        video.style.display = 'none'
        canvas.style.display = 'block'

        // æ˜¾ç¤ºç›¸å…³æŒ‰é’®
        takePhotoBtn.style.display = 'none'
        generateBtn.style.display = 'inline-block'
        retakeBtn.style.display = 'inline-block'
        saveBtn.style.display = 'inline-block'
      }

      // ä¿å­˜ç…§ç‰‡åŠŸèƒ½
      saveBtn.addEventListener('click', () => {
        const link = document.createElement('a')
        link.download = `selfie-${new Date().toISOString().slice(0, 10)}-${new Date().getTime()}.png`
        link.href = canvas.toDataURL()
        link.click()
      })

      // é‡æ–°æ‹ç…§
      retakeBtn.addEventListener('click', () => {
        photoContainer.innerHTML = ''
        startCamera()
      })

      // æ»¤é•œåˆ‡æ¢
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          currentFilter = e.target.dataset.filter
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'))
          e.target.classList.add('active')
          video.style.filter = filters[currentFilter]
        })
      })

      // å¯åŠ¨æ‘„åƒå¤´
      startCamera()

      // ç»‘å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
      takePhotoBtn.addEventListener('click', startCountdown)
      generateBtn.addEventListener('click', generatePhotos)

      // ä»…åœ¨éç§»åŠ¨ç«¯æ·»åŠ é”®ç›˜å¿«æ·é”®
      if (!isMobile) {
        document.addEventListener('keydown', (e) => {
          if (e.code === 'Space') {
            e.preventDefault()
            if (takePhotoBtn.style.display !== 'none') {
              startCountdown()
            } else if (generateBtn.style.display !== 'none') {
              generatePhotos()
            }
          } else if (e.code === 'KeyR') {
            retakeBtn.click()
          } else if (e.code === 'KeyS') {
            e.preventDefault()
            saveBtn.click()
          }
        })
      }
    })
  </script>
</body>

</html>
